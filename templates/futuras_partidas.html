<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Futuras Partidas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

</head>
<body class="bg-dark text-light">
    {% include 'navbar.html' %}
    <div class="container py-2">
        <div class="row mb-4">
            <div class="col-md-8 offset-md-2">
                <div class="card bg-secondary text-light">
                    <div class="card-header">
                        <h5 class="mb-0">üìã Cargar B√∫squeda Anterior</h5>
                    </div>
                    <div class="card-body">
                        <select class="form-select bg-dark text-light" id="previous-searches">
                            <option value="">-- Selecciona una b√∫squeda anterior --</option>
                        </select>
                        <small class="text-muted">Selecciona una configuraci√≥n previa para cargar autom√°ticamente todos los datos.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container py-4">
        <h2 class="text-center mb-4">‚öîÔ∏è Configurar L√≠neas</h2>
        <form method="POST">
            <div class="row g-4">
                <!-- Columna Team 1 -->
                <div class="col-md-6">
                    <div class="team-blue p-3 rounded-3">
                        <div class="mb-3">
                            <select class="form-select select2-team" name="team1" id="team1" required>
                                <option value="">Seleccionar Equipo 1</option>
                                {% for equipo in equipos %}
                                <option value="{{ equipo.id }}" data-image="{{ equipo.image }}" data-code="{{ equipo.code }}"
                                    {% if team1 and equipo.id == team1.id %}selected{% endif %}>
                                    {{ equipo.name }} ({{ equipo.code }})
                                </option>
                                {% endfor %}
                            </select>
                            {% if team1 %}
                            <span class="badge bg-primary ms-2">{{ prob_team1 }}%</span>
                            {% endif %}
                        </div>
                        <input type="number" step="0.01" 
                               class="form-control mb-3" 
                               name="cuota1" 
                               id="cuota1"
                               placeholder="Cuota Equipo Azul" 
                               value="{{ cuota1 if cuota1 }}" 
                               required>
                    </div>
                </div>
                <!-- Columna Team 2 -->
                <div class="col-md-6">
                    <div class="team-red p-3 rounded-3">
                        <div class="mb-3">
                            <select class="form-select select2-team" name="team2" id="team2" required>
                                <option value="">Seleccionar Equipo 2</option>
                                {% for equipo in equipos %}
                                <option value="{{ equipo.id }}" data-image="{{ equipo.image }}" data-code="{{ equipo.code }}"
                                    {% if team2 and equipo.id == team2.id %}selected{% endif %}>
                                    {{ equipo.name }} ({{ equipo.code }})
                                </option>
                                {% endfor %}
                            </select>
                            {% if team2 %}
                            <span class="badge bg-danger ms-2">{{ prob_team2 }}%</span>
                            {% endif %}
                        </div>
                        <input type="number" step="0.01" 
                               class="form-control mb-3" 
                               name="cuota2" 
                               id="cuota2"
                               placeholder="Cuota Equipo Rojo" 
                               value="{{ cuota2 if cuota2 }}" 
                               required>
                    </div>
                </div>
            </div>
            <div class="text-center mt-4">
                <button type="submit" class="btn btn-lg btn-success">
                    üßë‚Äçü§ù‚Äçüßë Calcular L√≠neas Jugadores
                </button>
                <button type="button" class="btn btn-lg btn-primary mb-2" onclick="calcularLineasKills()">
                    üî´ Calcular L√≠neas Kills
                </button>
            </div>
        </form>

        {% if jugadores_team1 or jugadores_team2 %}
          <form method="POST" id="mainForm">
                <input type="hidden" name="cuota1" id="hidden-cuota1"  value="{{ cuota1 if cuota1 }}" >
                <input type="hidden" name="cuota2" id="hidden-cuota2"  value="{{ cuota2 if cuota2 }}" >
                <input type="hidden" name="team1" id="hidden-team1"  value="{{ team1 if team1 }}" >
                <input type="hidden" name="team2" id="hidden-team2"  value="{{ team2 if team2 }}" >

          <div class="row mt-5 g-4">
              <!-- Jugadores Team 1 -->
              <div class="col-md-6">
                  {% for jugador in jugadores_team1 %}
                  <div class="card player-card mb-3 team-blue bg-dark text-light">
                      <div class="card-body">
                          <div class="d-flex justify-content-between align-items-center">
                              <div>
                                  <h5 class="card-title">{{ jugador.nickname }}</h5>
                                  <small class="text-info">{{ jugador.role|capitalize }}</small>
                              </div>
                              <div class="d-flex align-items-center gap-2">
                                  <button type="button" class="btn btn-sm btn-outline-danger" 
                                          onclick="adjustLine('{{ jugador.id }}', -1.0)">
                                      -
                                  </button>
                                  <input type="number" 
                                        id="linea-{{ jugador.id }}" 
                                        class="form-control linea-input text-center" 
                                        step="0.5" 
                                        name="linea_{{ jugador.id }}" 
                                        value="{{ jugador.linea }}"
                                        style="width: 100px;"
                                        onchange="validateLine('{{ jugador.id }}')">
                                  <button type="button" class="btn btn-sm btn-outline-success" 
                                          onclick="adjustLine('{{ jugador.id }}', 1.0)">
                                      +
                                  </button>
                              </div>
                          </div>
                          <div class="mt-3">
                                <div class="input-group fila-jugador">
                                    <!-- Over (Flecha arriba) -->
                                    <span class="input-group-text bg-success text-white">
                                        <i class="fas fa-arrow-up"></i>
                                        <span class="ms-2 d-none d-sm-inline">Over</span>
                                    </span>
                                    <input type="number" 
                                        step="0.01" 
                                        class="form-control cuota-over" 
                                        name="cuotaOver_{{ jugador.id }}" 
                                        id="cuota-over{{ jugador.id}}"
                                        placeholder="Cuota"
                                        style="border-left: none;">

                                    <!-- Under (Flecha abajo) -->
                                    <span class="input-group-text bg-danger text-white">
                                        <i class="fas fa-arrow-down"></i>
                                        <span class="ms-2 d-none d-sm-inline">Under</span>
                                    </span>
                                    <input type="number" 
                                        step="0.01" 
                                        class="form-control cuota-under" 
                                        name="cuotaUnder_{{ jugador.id }}" 
                                        id="cuota-under{{ jugador.id}}"
                                        placeholder="Cuota"
                                        style="border-right: none;">
                                </div>
                          </div>
                          <div class="mt-2">
                              <small>Avg kills: {{ jugador.avg_kills }}</small>
                          </div>
                      </div>
                  </div>
                  {% endfor %}
              </div>

              <!-- Jugadores Team 2 -->
              <div class="col-md-6">
                  {% for jugador in jugadores_team2 %}
                  <div class="card player-card mb-3 team-red bg-dark text-light">
                      <div class="card-body">
                          <div class="d-flex justify-content-between align-items-center">
                              <div>
                                  <h5 class="card-title">{{ jugador.nickname }}</h5>
                                  <small class="text-warning">{{ jugador.role|capitalize }}</small>
                              </div>
                              <div class="d-flex align-items-center gap-2">
                                  <button type="button" class="btn btn-sm btn-outline-danger" 
                                          onclick="adjustLine('{{ jugador.id }}', -1.0)">
                                      -
                                  </button>
                                  <input type="number" 
                                        id="linea-{{ jugador.id }}" 
                                        class="form-control linea-input text-center" 
                                        step="0.5" 
                                        value="{{ jugador.linea }}"
                                         name="linea_{{ jugador.id }}" 
                                        style="width: 100px;"
                                        onchange="validateLine('{{ jugador.id }}')">
                                  <button type="button" class="btn btn-sm btn-outline-success" 
                                          onclick="adjustLine('{{ jugador.id }}', 1.0)">
                                      +
                                  </button>
                              </div>
                            </div>
                            <div class="mt-3">
                                <div class="input-group fila-jugador">
                                    <!-- Over (Flecha arriba) -->
                                    <span class="input-group-text bg-success text-white">
                                        <i class="fas fa-arrow-up"></i>
                                        <span class="ms-2 d-none d-sm-inline">Over</span>
                                    </span>
                                    <input type="number" 
                                        step="0.01" 
                                        class="form-control cuota-over" 
                                        name="cuotaOver_{{ jugador.id }}" 
                                        id="cuota-over{{ jugador.id}}"
                                        placeholder="Cuota"
                                        style="border-left: none;">

                                    <!-- Under (Flecha abajo) -->
                                    <span class="input-group-text bg-danger text-white">
                                        <i class="fas fa-arrow-down"></i>
                                        <span class="ms-2 d-none d-sm-inline">Under</span>
                                    </span>
                                    <input type="number" 
                                        step="0.01" 
                                        class="form-control cuota-under" 
                                        name="cuotaUnder_{{ jugador.id }}" 
                                        id="cuota-under{{ jugador.id}}"
                                        placeholder="Cuota"
                                        style="border-right: none;">
                                </div>
                          </div>
                          <div class="mt-2">
                              <small>Avg kills: {{ jugador.avg_kills }}</small>
                          </div>
                      </div>
                  </div>
                  {% endfor %}
              </div>
          </div>
          <div class="mb-3">
            <label for="bans" class="form-label">Introduce los bans...</label>
            <select class="form-select select2-bans" name="bans[]" id="bans" multiple="multiple">
                {% for champion in champions %}
                <option value="{{ champion.id }}" data-image="{{ champion.image }}">
                    {{ champion.name }}
                </option>
                {% endfor %}
            </select>
        </div>
      <!-- Bot√≥n Calcular EV general -->
        <div class="text-center mt-4">
        <button type="submit" 
                class="btn btn-lg btn-warning" 
                formaction="/ev_calculo" 
                formtarget="_blank">
            üßÆ Calcular EV Kills
        </button>
    </div>
        {% endif %}
        
    </form>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // Configurar Select2 con im√°genes
        $('.select2-team').select2({
            templateResult: formatOption,
            templateSelection: formatOption,
            escapeMarkup: function(m) { return m; }
        });

        // Mapa bidireccional de equivalencias
        const cuotaMap = new Map([
            ['1.8', '1.9'], ['1.95', '1.75'], ['1.85', '1.850'], 
            ['2.4', '1.5'], ['1.65', '2.1'], ['2', '1.7'],
            ['1.6', '2.2'], ['1.55', '2.3'], ['1.4', '2.7'],
            ['1.2', '4'], ['1.3', '3'], ['1.45', '2.55']
        ]);

        // Normalizar entrada (compatibilidad con coma y punto decimal)
        const normalizarCuota = valor => {
            return valor.replace(',', '.').trim();
        };

        // Funci√≥n de conversi√≥n mejorada
        const convertirCuota = (valor, esUnder) => {
            const normalizado = normalizarCuota(valor);
            
            // Buscar en el mapa
            if(cuotaMap.has(normalizado)) return cuotaMap.get(normalizado);
            
            // B√∫squeda inversa si no existe
            for(const [key, value] of cuotaMap.entries()) {
                if(value === normalizado) return key;
            }
            
            
            return normalizado; // Mantener valor si no hay coincidencia
        };

        // Control de eventos con delegaci√≥n
        $(document).on('input', '.cuota-over', function() {
            const $input = $(this);
            const esOver = $input.hasClass('cuota-over');
            const $fila = $input.closest('.fila-jugador');
            const $objetivo = $fila.find('.cuota-under');

            const valorActual = normalizarCuota($input.val());
            const nuevoValor = convertirCuota(valorActual, esOver);
            
            if($objetivo  && nuevoValor && nuevoValor !== valorActual) {
                $objetivo.val(nuevoValor).trigger('change');
            }
        });

        function formatOption(option) {
            if (!option.id) return option.text;
            const image = $(option.element).data('image');
            return $('<span class="team-option"><img src="' + image + '">' + option.text + '</span>');
        }

        function adjustLine(jugadorId, value) {
          const input = document.getElementById(`linea-${jugadorId}`);
          let currentValue = parseFloat(input.value) || 0;
          currentValue += value;
          input.value = Math.max(currentValue, 0.5).toFixed(1);
      }

      function validateLine(jugadorId) {
          const input = document.getElementById(`linea-${jugadorId}`);
          let value = parseFloat(input.value) || 0;
          value = Math.round(value * 2) / 2; // Forzar m√∫ltiplos de 0.5
          input.value = Math.max(value, 0.5).toFixed(1);
      }

      function calcularLineasKills() {
            const team1 = document.getElementById('team1').value;
            const team2 = document.getElementById('team2').value;
            const cuota1 = document.getElementById('cuota1').value;
            const cuota2 = document.getElementById('cuota2').value;

            // Busca el div fijo o cr√©alo si no existe
            let killsContainer = document.getElementById('kills-lines-container');
            if (!killsContainer) {
                killsContainer = document.createElement('div');
                killsContainer.id = 'kills-lines-container';
                killsContainer.className = 'mt-4 p-3 border rounded';
                // Inserta el div despu√©s del formulario principal
                document.querySelector('form').after(killsContainer);
            }

            // Actualiza el contenido del div
            killsContainer.innerHTML = `
           <form action="/procesar_kills" method="POST" target="_blank" class="mt-4 p-3 border rounded">
            <input type="hidden" name="cuota1" id="hidden-cuota1" value="${cuota1}">
            <input type="hidden" name="cuota2" id="hidden-cuota2" value="${cuota2}">
            <input type="hidden" name="team1" id="hidden-team1" value="${team1}">
            <input type="hidden" name="team2" id="hidden-team2" value="${team2}">

            <h4 class="text-center mb-3">‚öîÔ∏è L√≠neas de Kills</h4>
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text bg-primary text-white">${team1}</span>
                        <input type="number" step="0.5" class="form-control" name="linea_kills_team1" value="10.5" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text bg-danger text-white">${team2}</span>
                        <input type="number" step="0.5" class="form-control" name="linea_kills_team2" value="-10.5" required>
                    </div>
                </div>
            </div>
            <div class="text-center mt-3">
                <button type="submit" class="btn btn-lg btn-warning">
                    üí• Calcular EV L√≠neas
                </button>
            </div>
        </form>
    `;

            // Muestra el div
            killsContainer.style.display = 'block';
        }

        // Para ocultar el div cuando el usuario selecciona otra cosa:
        function ocultarLineasKills() {
            const killsContainer = document.getElementById('kills-lines-container');
            if (killsContainer) {
                killsContainer.style.display = 'none';
            }
        }
        $('.select2-bans').select2({
            placeholder: "Introduce los bans...",
            allowClear: true, // Permite limpiar la selecci√≥n
            multiple: true,
            templateResult: formatBanOption,
            templateSelection: formatBanOption,
            escapeMarkup: function(m) { return m; }
        });

        document.querySelector('form[method="POST"]').addEventListener('submit', function(e) {
        if (this.dataset.programmaticSubmit == "true") {
            e.preventDefault(); // Evita recarga solo si es program√°tico
            // ... tu l√≥gica AJAX o lo que necesites ...
            // Limpia la marca para futuros submits manuales
            delete this.dataset.programmaticSubmit;
        }
        // Si no hay marca, el submit sigue su curso normal (recarga la p√°gina)
        });

        function formatBanOption(option) {
            if (!option.id) return option.text;
            const image = $(option.element).data('image');
            if (image) {
                return `<span><img src="${image}" style="width:32px;height:32px;object-fit:cover;margin-right:8px;">${option.text}</span>`;
            }
            return option.text;
        }

        $(document).ready(function() {
            // Cargar las b√∫squedas anteriores al inicializar la p√°gina
            loadPreviousSearches();
            
            // Configurar Select2 para el select de b√∫squedas anteriores
            $('#previous-searches').select2({
                placeholder: "Buscar y seleccionar configuraci√≥n anterior...",
                allowClear: true,
                theme: "bootstrap-5",
                width: '100%'
            });
            
            // Manejar la selecci√≥n de una b√∫squeda anterior
            $('#previous-searches').on('change', function() {
                const searchId = $(this).val();
                if (searchId) {
                    loadSearchData(searchId);
                }
            });
        });

        function loadPreviousSearches() {
            $.ajax({
                url: '/get_previous_searches',
                method: 'GET',
                success: function(searches) {
                    const select = $('#previous-searches');
                    select.empty();
                    select.append('<option value="">-- Selecciona una b√∫squeda anterior --</option>');
                    
                    searches.forEach(function(search) {
                        const formattedDate = new Date(search.fecha).toLocaleDateString('es-ES');
                        const displayText = `${formattedDate} - Teams: ${search.team1_id} vs ${search.team2_id}`;
                        select.append(`<option value="${search.id}">${displayText}</option>`);
                    });
                    
                    select.trigger('change');
                },
                error: function(xhr, status, error) {
                    console.error('Error cargando b√∫squedas anteriores:', error);
                }
            });
        }

        function loadSearchData(searchId) {
            $.ajax({
                url: `/get_search_data/${searchId}`,
                method: 'GET',
                success: function(data) {
                    fillFormWithData(data);
                },
                error: function(xhr, status, error) {
                    console.error('Error cargando datos de b√∫squeda:', error);
                    alert('Error al cargar los datos de la b√∫squeda');
                }
            });
        }

        function calcularLineasJugadoresProgramatico() {
            const form = document.querySelector('form[method="POST"]');
            if (form) {
                form.dataset.programmaticSubmit = "true";
                form.requestSubmit();
            }
        }

async function fillFormWithData(data) {
    console.log('Datos recibidos:', data);
    
    // Equipos y cuotas
    if (data.team1_id) $('#team1').val(data.team1_id).trigger('change');
    if (data.team2_id) $('#team2').val(data.team2_id).trigger('change');
    if (data.cuota1) $('#cuota1').val(data.cuota1);
    if (data.cuota2) $('#cuota2').val(data.cuota2);
    const waitTeam1 = new Promise(res => $('#team1').one('change', res));
    $('#team1').val(data.team1_id).trigger('change');
    const waitTeam2 = new Promise(res => $('#team2').one('change', res));
    $('#team2').val(data.team2_id).trigger('change');
    await waitTeam1;
    await waitTeam2;


    calcularLineasJugadoresProgramatico();
    // sup√≥n que esta funci√≥n dispara un evento cuando termina:
    await waitForMainFormVisible();
    console.log('#mainForm ahora es visible');
            Object.keys(data).forEach(key => {
                if (key.startsWith('linea_') || key.startsWith('cuotaOver_') || key.startsWith('cuotaUnder_')) {
                    const value = data[key];
                    if (value !== undefined && value !== '') {
                        // Buscar por name attribute
                        const input = $(`input[name="${key}"]`);
                        if (input.length) {
                            input.val(value);
                            console.log(`‚úì ${key}: ${value}`);
                        } else {
                            // Buscar por ID (para cuotas)
                            const jugadorId = key.split('_')[1];
                            let inputId = '';
                            
                            if (key.startsWith('linea_')) {
                                inputId = `#linea-${jugadorId}`;
                            } else if (key.startsWith('cuotaOver_')) {
                                inputId = `#cuota-over${jugadorId}`;
                            } else if (key.startsWith('cuotaUnder_')) {
                                inputId = `#cuota-under${jugadorId}`;
                            }
                            
                            const inputById = $(inputId);
                            if (inputById.length) {
                                inputById.val(value);
                                console.log(`‚úì ${key} (por ID): ${value}`);
                            } else {
                                console.warn(`‚úó No encontrado: ${key}`);
                            }
                        }
                    }
                }
            });
              fillBansData(data);
  showSuccessMessage('Cuotas de jugadores cargadas');
}

function waitForMainFormVisible(timeout = 5000) {
  return new Promise((resolve, reject) => {
    const start = Date.now();
    function check() {
      const $form = $('#mainForm');
      // Si existe y es visible
      if ($form.length && $form.is(':visible')) return resolve();
      if (Date.now() - start > timeout) return reject('Timeout esperando que #mainForm sea visible');
      setTimeout(check, 100);
    }
    check();
  });
}

function fillBansData(data) {
    console.log('=== PROCESANDO BANS ===');
    console.log('Datos recibidos:', data);
    
    let bansArray = [];
    
    // Caso 1: Los bans vienen como "bans[]": "valor_√∫nico"
    if (data['bans[]']) {
        // Si es un string √∫nico, convertirlo a array
        if (typeof data['bans[]'] === 'string') {
            bansArray = [data['bans[]']];
        } else if (Array.isArray(data['bans[]'])) {
            bansArray = data['bans[]'];
        }
        console.log('Bans desde bans[]:', bansArray);
    }
    
    // Caso 2: Los bans vienen como array directo
    else if (data.bans && Array.isArray(data.bans)) {
        bansArray = data.bans;
        console.log('Bans como array:', bansArray);
    }
    
    // Caso 3: Los bans vienen como string JSON
    else if (data.bans && typeof data.bans === 'string') {
        try {
            bansArray = JSON.parse(data.bans);
            console.log('Bans parseados desde JSON:', bansArray);
        } catch (e) {
            bansArray = data.bans.split(',').map(ban => ban.trim()).filter(ban => ban !== '');
            console.log('Bans desde string separado por comas:', bansArray);
        }
    }
    
    // Caso 4: Buscar campos individuales ban_1, ban_2, etc.
    else {
        Object.keys(data).forEach(key => {
            if (key.startsWith('ban_') && data[key]) {
                bansArray.push(data[key]);
            }
        });
        console.log('Bans desde campos individuales:', bansArray);
    }
    
    // Aplicar los bans al select
    if (bansArray.length > 0) {
        const bansStrings = bansArray.map(ban => String(ban));
        $('#bans').val(bansStrings).trigger('change');
        console.log('‚úì Bans aplicados:', bansStrings);
    } else {
        $('#bans').val([]).trigger('change');
        console.log('‚úì No hay bans - select limpiado');
    }
    
    console.log('=== FIN PROCESAMIENTO BANS ===');
}




        function showSuccessMessage(message) {
            const alert = $(`
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            
            $('.container').first().prepend(alert);
            
            setTimeout(() => {
                alert.alert('close');
            }, 3000);
        }


    </script>
</body>
</html>